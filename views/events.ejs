<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Campus Events</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/style/index.css">

  <style>
    body {
      background-color: #f8f9fa;
    }

    .logo {
      font-family: 'Montserrat', sans-serif;
      font-size: 2rem !important;
      /* Force it to resize */
      font-weight: 800;
      color: black !important;
      text-transform: uppercase;
    }

    .hero {
      background: linear-gradient(200deg, #454546, #6c94cf);
      color: white;
      padding: 4rem 1rem;
      text-align: center;
    }

    .event-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      transition: transform 0.2s ease;
    }

    .event-card:hover {
      transform: translateY(-5px);
    }
  </style>
</head>

<body>

  <%- include('partials/nav') %>

    <!-- Hero Section -->
    <div class="hero">
      <h1 class="display-5 fw-bold">Campus Events</h1>
      <p class="lead">Discover amazing events happening around campus!</p>
      <!-- Admin Create Event Button -->
      <div class="text-center my-3">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">
          + Create Event
        </button>
      </div>
    </div>



    <!-- Event List -->
    <div class="container py-5">
      <div class="row mb-4">
        <div class="col-md-8">
          <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Search events...">
        </div>
        <div class="col-md-4">
          <select id="categorySelect" class="form-select form-select-lg">
            <option value="All">All</option>
            <option value="Technology">Technology</option>
            <option value="Cultural">Cultural</option>
            <option value="Career">Career</option>
            <option value="Sports">Sports</option>
            <option value="Academic">Academic</option>
            <option value="Environment">Environment</option>
          </select>
        </div>
      </div>

      <!-- Event Grid -->
      <div class="row" id="eventsGrid">
        <!-- Events will be loaded dynamically -->
      </div>
    </div>

    <!-- Create Event Modal -->
    <div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="createEventForm">
            <div class="modal-header">
              <h5 class="modal-title" id="createEventModalLabel">Create Event</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" name="title" class="form-control" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3" required></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-control" required>
              </div>

              <div class="row mb-3">
                <div class="col">
                  <label class="form-label">From</label>
                  <input type="time" name="timeFrom" class="form-control" required>
                </div>
                <div class="col">
                  <label class="form-label">To</label>
                  <input type="time" name="timeTo" class="form-control" required>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Location</label>
                <input type="text" name="location" class="form-control" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select" required>
                  <option value="Technology">Technology</option>
                  <option value="Cultural">Cultural</option>
                  <option value="Career">Career</option>
                  <option value="Sports">Sports</option>
                  <option value="Academic">Academic</option>
                  <option value="Environment">Environment</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Organizer</label>
                <input type="text" name="organizer" class="form-control" required>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Create Event</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      const grid = document.getElementById("eventsGrid");
      const searchInput = document.getElementById("searchInput");
      const categorySelect = document.getElementById("categorySelect");
      const createForm = document.getElementById("createEventForm");

      // Load events dynamically
      async function loadEvents() {
        try {
          const res = await fetch("/api/events");
          const events = await res.json();

          grid.innerHTML = "";
          if (events.length === 0) {
            grid.innerHTML = '<div class="text-center text-muted my-5"><h4>No events found</h4></div>';
            return;
          }

          events.forEach(ev => {
            const div = document.createElement("div");
            div.className = "col-md-4 mb-4 event-item";
            div.dataset.category = ev.category;
            div.innerHTML = `
            <div class="event-card">
              <h5>${ev.title}</h5>
              <p>${ev.description}</p>
              <p><strong>Date:</strong> ${new Date(ev.date).toLocaleDateString()}</p>
              <p><strong>Time:</strong> ${ev.timeFrom} - ${ev.timeTo}</p>
              <p><strong>Location:</strong> ${ev.location}</p>
              <p><strong>Category:</strong> ${ev.category}</p>
              <p><strong>Organizer:</strong> ${ev.organizer}</p>
            </div>
          `;
            grid.appendChild(div);
          });

          filterEvents();
        } catch (err) {
          console.error("Failed to load events:", err);
        }
      }

      // Filter events
      function filterEvents() {
        const searchText = searchInput.value.toLowerCase();
        const selectedCategory = categorySelect.value;

        document.querySelectorAll(".event-item").forEach(item => {
          const title = item.querySelector("h5").textContent.toLowerCase();
          const description = item.querySelector("p").textContent.toLowerCase();
          const category = item.dataset.category;

          const matchesSearch = title.includes(searchText) || description.includes(searchText);
          const matchesCategory = selectedCategory === "All" || category === selectedCategory;

          item.style.display = matchesSearch && matchesCategory ? "block" : "none";
        });
      }

      // Handle event creation via AJAX
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(createForm);
        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch('/admin/createEvent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (res.ok) {
            // Close modal
            const modalEl = document.getElementById('createEventModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            createForm.reset();
            loadEvents(); // refresh grid immediately
          } else {
            console.error('Failed to create event');
          }
        } catch (err) {
          console.error(err);
        }
      });

      // Event listeners
      searchInput.addEventListener("input", filterEvents);
      categorySelect.addEventListener("change", filterEvents);

      // Initial load
      loadEvents();
      setInterval(loadEvents, 6000); // auto-refresh every 2 sec
    </script>
</body>

</html>