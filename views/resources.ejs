<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resources | Loop</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="/style/index.css">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f8f9fa;
    }

    /* Hero section */
    .hero {
      padding: 100px 15px;
      background: linear-gradient(to bottom, #e8f0ff, #ffffff);
      text-align: center;
    }

    .hero h2 {
      font-size: 2.8rem;
      font-weight: 700;
      color: #0d6efd;
      margin-bottom: 20px;
    }

    .hero p {
      color: #6c757d;
      max-width: 600px;
      margin: 0 auto 30px;
    }

    /* Resource cards */
    .resource-card {
      transition: all 0.3s ease;
    }

    .resource-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Upload form */
    .upload-section {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 30px;
    }
  </style>
</head>

<body>
  <%- include('partials/nav') %>

  <!-- ✅ Hero Section -->
  <section class="hero">
    <div class="container">
      <h2>Learning grows stronger in the Loop</h2>
      <p>Share your notes, learn from others, and grow together — that’s the Loop way.</p>
      <div class="d-flex flex-column flex-sm-row justify-content-center gap-3">
        <% if (user) { %>
          <a href="#upload" class="btn btn-primary px-4">Upload Resources</a>
        <% } %>
        <a href="#resources" class="btn btn-outline-secondary px-4">Browse Library</a>
      </div>
    </div>
  </section>

  <!-- ✅ Resource Browser -->
  <section id="resources" class="py-5">
    <div class="container">
      <h3 class="text-center fw-bold mb-4">Browse Resources</h3>

      <div class="row justify-content-center mb-4">
        <div class="col-md-4 mb-2">
          <input id="searchInput" type="text" class="form-control" placeholder="Search resources...">
        </div>
        <div class="col-md-3 mb-2">
          <select id="categorySelect" class="form-select">
            <option value="All">All</option>
            <option value="Textbook">Textbooks</option>
            <option value="Assignment">Assignments</option>
            <option value="Paper">Research Papers</option>
            <option value="Notes">Lecture Notes</option>
            <option value="Books">Books</option>
            <option value="Links">Study Links</option>
            <option value="Others">Others</option>
          </select>
        </div>
      </div>

      <div id="resourceGrid" class="row g-4 justify-content-center">
        <!-- Resources will load dynamically -->
      </div>
    </div>
  </section>

  <!-- ✅ Upload Section -->
  <% if (user) { %>
    <section id="upload" class="py-5">
      <div class="container">
        <h3 class="text-center fw-bold mb-4">Upload Your Resource</h3>

        <div class="upload-section mx-auto" style="max-width: 600px;">
          <form id="uploadForm">
            <div class="mb-3">
              <input type="text" name="title" class="form-control" placeholder="Resource Title *" required>
            </div>
            <div class="mb-3">
              <input type="text" name="subject" class="form-control" placeholder="Subject *" required>
            </div>
            <div class="mb-3">
              <select name="category" class="form-select" required>
                <option value="">Select Category</option>
                <option value="Textbook">Textbook</option>
                <option value="Assignment">Assignment</option>
                <option value="Paper">Research Paper</option>
                <option value="Notes">Notes</option>
                <option value="Books">Books</option>
                <option value="Links">Links</option>
                <option value="Others">Others</option>
              </select>
            </div>
            <div class="mb-3">
              <textarea name="description" class="form-control" rows="3" placeholder="Description *" required></textarea>
            </div>
            <div class="mb-3">
              <input type="file" id="fileInput" name="files" multiple class="form-control">
            </div>
            <button type="submit" class="btn btn-primary w-100">Upload Resource</button>
          </form>
        </div>
      </div>
    </section>
  <% } %>

  <!-- ✅ Modal for Viewing File -->
  <div class="modal fade" id="fileViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Resource Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div id="fileViewerContainer">
            <iframe id="fileViewer" src="" width="100%" height="600px" frameborder="0"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Page Script -->
  <script>
    const grid = document.getElementById("resourceGrid");
    const searchInput = document.getElementById("searchInput");
    const categorySelect = document.getElementById("categorySelect");
    const uploadForm = document.getElementById("uploadForm");

    async function loadResources() {
      try {
        const res = await fetch("/resource/all");
        const resources = await res.json();
        grid.innerHTML = "";

        if (resources.length === 0) {
          grid.innerHTML = '<p class="text-center text-muted">No resources found</p>';
          return;
        }

                resources.forEach(r => {
            const col = document.createElement("div");
            col.className = "col-md-4 col-sm-6";
            col.innerHTML = `
              <div class="card resource-card h-100">
                <div class="card-body">
                  <span class="badge bg-primary">${r.category}</span>
                  <h5 class="card-title mt-2">${r.title}</h5>
                  <p class="card-subtitle text-muted">${r.subject}</p>
                  <p class="card-text mt-2">${r.description}</p>
                  <div class="d-flex flex-wrap gap-2">
                    ${(r.files || []).map((f, i) => `
                      <a href="/resource/view/${r._id}/${i}" 
                        target="_blank" 
                        class="btn btn-sm btn-outline-primary">
                        View
                      </a>
                    `).join("")}
                  </div>
                </div>
              </div>`;
            grid.appendChild(col);
          });

        filterResources();
      } catch (err) {
        console.error("Failed to load resources:", err);
      }
    }

    function filterResources() {
      const searchText = searchInput.value.toLowerCase();
      const selectedCategory = categorySelect.value;
      document.querySelectorAll(".card").forEach((item) => {
        const title = item.querySelector(".card-title").textContent.toLowerCase();
        const desc = item.querySelector(".card-text").textContent.toLowerCase();
        const category = item.querySelector(".badge").textContent;
        const matchesSearch = title.includes(searchText) || desc.includes(searchText);
        const matchesCategory = selectedCategory === "All" || category.toLowerCase() === selectedCategory.toLowerCase();
        item.parentElement.style.display = matchesSearch && matchesCategory ? "block" : "none";
      });
    }

    // ✅ Function to open file inside modal
    function openFileModal(id, index) {
      const viewer = document.getElementById("fileViewer");
      viewer.src = `/resource/view/${id}/${index}`;
      const modal = new bootstrap.Modal(document.getElementById("fileViewModal"));
      modal.show();
    }

    if (uploadForm) {
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const res = await fetch("/resource/upload", { method: "POST", body: formData });
        if (res.ok) {
          alert("Resource uploaded successfully!");
          uploadForm.reset();
          loadResources();
        } else {
          alert("Failed to upload resource");
        }
      });
    }

    searchInput.addEventListener("input", filterResources);
    categorySelect.addEventListener("change", filterResources);

    loadResources();
  </script>

</body>
</html>
